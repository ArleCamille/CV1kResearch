# U13 Reverse Engineering

![Probes](/pics/probes.jpg "Probes connected to CPLD")

## Background and objectives

CV-1000 PCBs does not have any custom ASICs, which makes them quite repairable if something breaks down. The EPM7032 CPLD at U13 however is not dumped, and is written with its protection bit set, making it hard to dump its internal flash. This means that if its internal flash goes bad, the PCB will not start and there's no good way to replace it.

The main goals of this project are:

- Research and document the behavior of this IC.
- Produce an open source EPM7032 bitstream with the same functions as the original flash, to make it possible to repair CV1000 boards with faulty U13 circuits.

## Disclaimer

I'm a hobbyist, and there's highly likely that there will be some mistakes in this documentation. Information here is based on observations with a logic analyzer (Saleae Logic Pro 16).

## Description of U13 functionality

#### Address decoder

The main responsibility of U13 is as an address decoder for:
- U2 Flash (Graphics and other non-sound assets)
- YMZ770 (Audio)
- RTC-9701 (EEPROM/RTC).

When SH-3 performs a read, it will sink its RD pin (#88). When it performs a write, it will sink its WE0 pin (#89).

All three devices above are mapped to the memory range [0x10000000 - 0x14000000) which will sink the SH-3 CS4 pin (#100) when addressed (see page 229 of SH-3 datasheet). Each device has its own offset from the starting address, which is visible to the EPM7032 by looking at bits A23 and A22 of the address bus. Start of address ranges are:

- 0x10000000 (A22=0, A23=0) : U2
- 0x10400000 (A22=1, A23=0) : Audio
- 0x10C00000 (A22=1, A23=1) : EEPROM/RTC... with some extras (see below)

The lowest three bits of the address bus are also connected to the CPLD, and are used to signal the type of operation to perform. In practice, this doesn't seem like it's needed by the CPLD to handle signaling with the other devices though with these exceptions:

1. U2 Chip Enable

This is signaled in the EEPROM/RTC namespace by a write to 0x10C00003. For writes here, CE pin of U2 is set to data[0].

2. Device initialization

During startup, SH-3 will start by reading data from U4, and then do a write to 0x10C00002 which has data[3:0] set to 4'b0001. It will then communicate with the FPGA (load blitter bitstream most likely), and finally send 4'b1110 to the same address. At this point, the device initialized seems done.

#### Blitter access passthrough

In addition to the address decoder above, U13 passes on the Blitter accesses to the FPGA. It's a bit unclear to me why this goes through the CPLD, since it looks like the Blitter access pin is just tied to CS6 (possibly not at device setup?).

#### Clocks

There's two clock signals visible on U13.

- CKIO from SH-3 on pin 37. This is aprox 50Mhz.
- Some other clock on pin 15. Same frequency as CKIO, but different offset.

The second clock signal is not started until some time after the upload of blitter data to the FPGA. I initially thought that the second clock signal was passing through the clock input to the FPGA when initialized, but it doesn't really look like there is something triggering this on the CPLD. Currently I suspect this is generated by FPGA, but not clear why U13 would need this.

#### Unknown things

There are several signals connected to/from U13 that I've never seen used, when triggering on them.

- SH-3 WAIT is connected to CPLD, but never seems to go low.
- Audio PLAY feedback signal is connected, but doesn't seem to be used.
- Is the second clock signal used for anything?
- RTC-9701 /TIRQ seems unused. Always low.
- CS5 is connected, but doesn't seem used. Maps to address range [0x14000000-0x18000000)

There's a possibility these are used for some edge cases I've not implemented in my bitstream.

## Higher level notes on EPM7032 usage on CV1000

Operation voltage is 3.3V.

U13 utilizes the JTAG pins for IO, which means that it is not possible to program it with a simple ISP programmer. Instead an expensive programmer like Elnec Beeprog2 needs to be used.

The IC often has labels with the name of the game on it, but I haven't seen any real indication that the behavior should differ between games.

Pins 38-40 are connected to pins 42-44 on the PCB. This seems to be to be able to trigger the Global Clear and OE signals of the CPLD.

## Notes on using logic analyzers with the IC

To get an accurate look at clock signals (>50hz), you want to use a sample rate of at least 200Mhz. For some other signals like the EEPROM, the clock generated from the CPLD is significantly lower and a lower sample rate can be used.

Use at least a 12 channel logic analyzer, since ideally you want to at least look at the following signals at the same time for analysis:

- Clock
- At least one chip select pin from SH-3
- CS, Read, Write pins for the connected IC
- Address bus (A0,A1,A22,A23)
- Data bus (at least lower three bits)

For hooking up probes to the EPM7032, high quality micro grabbers need to be used. I use these. https://www.reichelt.com/de/en/smd-complete-measuring-set-30-piece-ms-6800-12-p63479.html

The data bus is also connected to the 4 pins of P3 closest to the SH-3, which makes them easy to probe that way, even with cheap grabbers.

## Notes on programming CPLD

Since EPM7032 is an old CPLD in the MAX7000 family, you'll have to use a very old Quartus version to be able to program it. I used 9.1 sp2 Free version.

Intel no longer hosts this, but you can find it here: https://archive.org/details/91sp-2-quartus-free

## Some more pics

![chips](/pics/chips.jpg "Original with two custom")

![soldered](/pics/soldered.jpg "Soldered to board")
